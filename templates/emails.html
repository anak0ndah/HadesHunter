{% extends "layout.html" %}

{% block title %}Emails - HadesHunter{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-2"><i class="bi bi-microsoft me-2"></i>Outlook Email Scanner</h2>
        <p class="text-muted mb-4">Scan your Outlook inbox for passwords, API keys, tokens, and sensitive credentials.</p>
        
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-key me-2"></i>Microsoft Graph Token</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="form-label">Refresh Token</label>
                            <textarea class="form-control token-input" id="refreshToken" rows="3" 
                                placeholder="Paste your Microsoft refresh token here..."></textarea>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Tenant</label>
                            <input type="text" class="form-control" id="tenant" placeholder="common" value="common">
                        </div>
                        <button class="btn btn-primary w-100" onclick="configureToken()">
                            <i class="bi bi-check-circle me-2"></i>Configure Token
                        </button>
                    </div>
                </div>
                <div id="tokenStatus" class="mt-3" style="display: none;">
                    <div class="alert alert-success mb-0">
                        <i class="bi bi-check-circle me-2"></i>
                        <span id="tokenStatusText">Token configured</span>
                    </div>
                </div>
            </div>
        </div>
        
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-shield-check me-2"></i>Secret Detection Scan</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    Scans your inbox using the <strong>built-in secret detector</strong> with 30+ patterns: 
                    AWS Keys, Azure Secrets, GitHub Tokens, JWT, Passwords, API Keys, Connection Strings, etc.
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Number of Emails to Scan</label>
                        <select class="form-select" id="maxResults">
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="200" selected>200</option>
                            <option value="500">500</option>
                            <option value="1000">ALL (1000+)</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-danger w-100 btn-lg" onclick="scanEmails()" id="scanBtn">
                            <i class="bi bi-search me-2"></i>Scan Inbox for Secrets
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-inbox me-2"></i>Detected Secrets</h5>
                <span class="badge bg-danger" id="resultsCount">0 secrets</span>
            </div>
            <div class="card-body">
                <div id="emailResults">
                    <p class="text-muted text-center py-4">Configure token and scan to detect secrets</p>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="secretModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="secretModalTitle">Secret Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="secretModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function configureToken() {
    const refreshToken = document.getElementById('refreshToken').value.trim();
    const tenant = document.getElementById('tenant').value.trim() || 'common';
    
    if (!refreshToken) {
        showToast('Error', 'Please enter a refresh token', 'error');
        return;
    }
    
    showLoading('Configuring Graph API token...');
    
    try {
        const response = await fetch('/api/set_graph_token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ refresh_token: refreshToken, tenant: tenant })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('tokenStatus').style.display = 'block';
            document.getElementById('tokenStatusText').textContent = 
                `Token configured for ${data.token_info.user}`;
            showToast('Success', 'Graph API token configured successfully', 'success');
        } else {
            showToast('Error', data.error || 'Failed to configure token', 'error');
        }
    } catch (error) {
        showToast('Error', 'Failed to configure token: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

async function scanEmails() {
    const maxResults = parseInt(document.getElementById('maxResults').value);
    
    showLoading(`Scanning ${maxResults} emails for secrets...`);
    document.getElementById('scanBtn').disabled = true;
    
    try {
        const response = await fetch('/api/scan_emails_secrets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ max_results: maxResults })
        });
        
        const data = await response.json();
        
        if (data.error) {
            showToast('Error', data.error, 'error');
            return;
        }
        
        displaySecretResults(data);
        
        if (data.total_secrets > 0) {
            showToast('Secrets Found!', `Found ${data.total_secrets} secrets in ${data.emails_with_secrets} emails!`, 'warning');
        } else {
            showToast('Scan Complete', `Scanned ${data.emails_scanned} emails - No secrets detected`, 'success');
        }
    } catch (error) {
        showToast('Error', 'Scan failed: ' + error.message, 'error');
    } finally {
        hideLoading();
        document.getElementById('scanBtn').disabled = false;
    }
}

function displaySecretResults(data) {
    const container = document.getElementById('emailResults');
    document.getElementById('resultsCount').textContent = `${data.total_secrets} secrets`;
    
    if (!data.secrets || data.secrets.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-check-circle text-success fs-1"></i>
                <p class="mt-3">Scanned <strong>${data.emails_scanned}</strong> emails<br>
                <span class="text-success">No secrets detected</span></p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="alert alert-warning mb-3">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Scanned <strong>${data.emails_scanned}</strong> emails - 
            Found <strong>${data.total_secrets}</strong> secrets in <strong>${data.emails_with_secrets}</strong> emails
        </div>
        <div class="table-responsive">
            <table class="table table-hover" id="secretsTable">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Secret (Redacted)</th>
                        <th>Email Subject</th>
                        <th>Sender</th>
                        <th>Confidence</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    for (const secret of data.secrets) {
        const confidenceClass = secret.confidence >= 0.8 ? 'bg-danger' : 
                               secret.confidence >= 0.6 ? 'bg-warning' : 'bg-secondary';
        
        html += `
            <tr>
                <td><span class="badge bg-primary">${escapeHtml(secret.type)}</span></td>
                <td><code class="text-danger">${escapeHtml(secret.redacted_value)}</code></td>
                <td>
                    <small class="text-truncate d-block" style="max-width: 200px;" title="${escapeHtml(secret.email_subject || '')}">
                        ${escapeHtml(secret.email_subject || '(No subject)')}
                    </small>
                </td>
                <td><small>${escapeHtml(secret.sender || '')}</small></td>
                <td><span class="badge ${confidenceClass}">${Math.round(secret.confidence * 100)}%</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info" onclick="viewSecretDetails(${JSON.stringify(secret).replace(/"/g, '&quot;')})" title="Details">
                            <i class="bi bi-info-circle"></i>
                        </button>
                        <button class="btn btn-outline-warning" onclick="showEmailContext('${secret.message_id}', '${escapeHtml(secret.raw_value || secret.redacted_value)}', '${escapeHtml(secret.type)}', ${secret.confidence})" title="Show Context">
                            <i class="bi bi-file-text"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="downloadEmail('${secret.message_id}')" title="Download">
                            <i class="bi bi-download"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
    
    $('#secretsTable').DataTable({
        order: [[4, 'desc']],
        pageLength: 25
    });
}

function viewSecretDetails(secret) {
    document.getElementById('secretModalTitle').textContent = secret.type;
    document.getElementById('secretModalBody').innerHTML = `
        <div class="mb-3">
            <strong>Secret Type:</strong> <span class="badge bg-primary">${escapeHtml(secret.type)}</span>
        </div>
        <div class="mb-3">
            <strong>Redacted Value:</strong><br>
            <code class="text-danger fs-5">${escapeHtml(secret.redacted_value)}</code>
        </div>
        <div class="mb-3">
            <strong>Confidence:</strong> ${Math.round(secret.confidence * 100)}%
        </div>
        <div class="mb-3">
            <strong>Entropy:</strong> ${secret.entropy}
        </div>
        <hr>
        <div class="mb-3">
            <strong>Email Subject:</strong> ${escapeHtml(secret.email_subject || '(No subject)')}
        </div>
        <div class="mb-3">
            <strong>Sender:</strong> ${escapeHtml(secret.sender || 'Unknown')}
        </div>
        <div class="mb-3">
            <strong>Date:</strong> ${formatTimestamp(secret.timestamp)}
        </div>
        <hr>
        <div class="mb-3">
            <strong>Context:</strong>
            <pre class="bg-secondary p-2 rounded mt-2" style="white-space: pre-wrap;">...${escapeHtml(secret.context_before || '')} <mark class="bg-danger text-white">${escapeHtml(secret.redacted_value)}</mark> ${escapeHtml(secret.context_after || '')}...</pre>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('secretModal'));
    modal.show();
}

function downloadEmail(emailId) {
    window.open(`/api/download_email/${emailId}`, '_blank');
}

async function showEmailContext(emailId, secretValue, secretType = 'Secret', confidence = 0) {
    showLoading('Loading email content...');
    
    try {
        const response = await fetch('/api/get_email/' + emailId);
        const data = await response.json();
        
        if (data.error) {
            showToast('Error', data.error, 'error');
            return;
        }
        
        const email = data.email;
        let bodyContent = email.body?.content || email.bodyPreview || 'No content available';
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = bodyContent;
        let cleanBody = tempDiv.textContent || tempDiv.innerText || '';
        cleanBody = cleanBody.replace(/\s+/g, ' ').trim();
        
        // Highlight secret in content
        let highlightedBody = escapeHtml(cleanBody);
        if (secretValue && secretValue.length > 3) {
            const secretRegex = new RegExp('(' + escapeRegex(secretValue) + ')', 'gi');
            highlightedBody = highlightedBody.replace(secretRegex, '<mark class="bg-danger text-white px-1 rounded">$1</mark>');
        }
        
        const modalHtml = `
            <div class="modal fade" id="contextModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content bg-dark">
                        <div class="modal-header border-danger">
                            <div>
                                <i class="bi bi-envelope text-info me-2"></i>
                                <strong>${escapeHtml(email.subject || '(No subject)')}</strong>
                            </div>
                            <div>
                                <span class="badge bg-danger me-2"><i class="bi bi-exclamation-triangle me-1"></i>Contains Potential Secret</span>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="small"><strong>From:</strong> ${escapeHtml(email.from?.emailAddress?.name || '')} &lt;${escapeHtml(email.from?.emailAddress?.address || '')}&gt;</div>
                                    <div class="small"><strong>To:</strong> ${email.toRecipients?.map(r => escapeHtml(r.emailAddress?.address || '')).join(', ') || 'N/A'}</div>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <div class="small text-muted"><i class="bi bi-clock me-1"></i>${formatTimestamp(email.sentDateTime)}</div>
                                    <div class="small text-muted"><i class="bi bi-envelope me-1"></i>ID: ${emailId.substring(0, 20)}...</div>
                                </div>
                            </div>
                            
                            <div class="card bg-dark border-secondary mb-3">
                                <div class="card-header d-flex justify-content-between">
                                    <span><i class="bi bi-body-text me-2"></i>Email Content</span>
                                    <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i>Secret highlighted in red</span>
                                </div>
                                <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                                    <div style="white-space: pre-wrap; word-break: break-word; font-size: 0.9rem; line-height: 1.6;">${highlightedBody}</div>
                                </div>
                            </div>
                            
                            <div class="card bg-danger bg-opacity-10 border-danger">
                                <div class="card-header text-danger">
                                    <i class="bi bi-shield-exclamation me-2"></i>Detected Secret
                                </div>
                                <div class="card-body">
                                    <div class="d-flex align-items-center p-2 bg-dark rounded">
                                        <span class="badge bg-warning text-dark me-3">${escapeHtml(secretType)}</span>
                                        <code class="text-danger flex-grow-1" style="font-size: 1rem;">${escapeHtml(secretValue)}</code>
                                        <span class="badge bg-secondary ms-2">${Math.round(confidence * 100)}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-info" onclick="downloadEmail('${emailId}')">
                                <i class="bi bi-download me-2"></i>Download .eml
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const existingModal = document.getElementById('contextModal');
        if (existingModal) existingModal.remove();
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('contextModal'));
        modal.show();
    } catch (error) {
        showToast('Error', 'Failed to load email: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}
</script>
{% endblock %}
