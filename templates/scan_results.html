{% extends 'layout.html' %}

{% block title %}HadesHunter - Results{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="bi bi-list-check text-primary me-2"></i>
                Scan Results
            </h1>
            <div>
                <button class="btn btn-outline-danger me-2" onclick="clearAllResults()">
                    <i class="bi bi-trash me-1"></i>Clear All
                </button>
                <button class="btn btn-outline-success me-2" onclick="exportResults()">
                    <i class="bi bi-download me-1"></i>Export Secrets
                </button>
                <a href="/" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back to Scanner
                </a>
            </div>
        </div>
    </div>
</div>


<div class="row mb-4" id="statsRow">
    <div class="col-md-3">
        <div class="stats-card">
            <div class="number" id="secretsCount">-</div>
            <div class="label">Secrets Found</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="number" id="conversationsCount">-</div>
            <div class="label">Conversations Scanned</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="number" id="messagesCount">-</div>
            <div class="label">Messages Analyzed</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="number" id="scanTime" style="font-size: 1.2rem;">-</div>
            <div class="label">Scan Time</div>
        </div>
    </div>
</div>


<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label class="form-label">Filter by Type</label>
                        <select class="form-select" id="filterType" onchange="filterResults()">
                            <option value="">All Types</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Filter by Source</label>
                        <select class="form-select" id="filterSource" onchange="filterResults()">
                            <option value="">All Sources</option>
                            <option value="teams">Teams</option>
                            <option value="email">Emails</option>
                            <option value="file">Files</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Min Confidence</label>
                        <select class="form-select" id="filterConfidence" onchange="filterResults()">
                            <option value="0">All</option>
                            <option value="0.5">50%+</option>
                            <option value="0.7">70%+</option>
                            <option value="0.8">80%+</option>
                            <option value="0.9">90%+</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search in results..." oninput="filterResults()">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-12">
        <div id="resultsContainer">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading results...</p>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="contextModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-chat-text me-2"></i>
                    Message Context
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contextModalBody">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allResults = [];
    let displayedResults = [];
    let currentScanId = null;
    
    document.addEventListener("DOMContentLoaded", loadResults);
    
    async function loadResults() {
        try {
            const response = await fetch("/api/get_results");
            const data = await response.json();
            
            allResults = data.secrets || [];
            currentScanId = data.scan_id;
            
            // Update stats
            document.getElementById("secretsCount").textContent = allResults.length;
            document.getElementById("conversationsCount").textContent = data.conversations_scanned || 0;
            document.getElementById("messagesCount").textContent = data.messages_scanned || 0;
            
            // Format scan time properly
            if (data.scan_time) {
                const scanDate = new Date(data.scan_time);
                document.getElementById("scanTime").textContent = scanDate.toLocaleString();
            } else {
                document.getElementById("scanTime").textContent = "-";
            }
            
            // Populate type filter
            const types = [...new Set(allResults.map(s => s.type))];
            const filterType = document.getElementById("filterType");
            types.forEach(type => {
                const option = document.createElement("option");
                option.value = type;
                option.textContent = type;
                filterType.appendChild(option);
            });
            
            renderResults(allResults);
            
        } catch (error) {
            document.getElementById("resultsContainer").innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Failed to load results: ${error.message}
                </div>
            `;
        }
    }
    
    function filterResults() {
        const typeFilter = document.getElementById("filterType").value;
        const sourceFilter = document.getElementById("filterSource").value;
        const confidenceFilter = parseFloat(document.getElementById("filterConfidence").value);
        const searchFilter = document.getElementById("searchInput").value.toLowerCase();
        
        let filtered = allResults;
        
        if (typeFilter) {
            filtered = filtered.filter(s => s.type === typeFilter);
        }
        
        if (sourceFilter) {
            filtered = filtered.filter(s => getSource(s) === sourceFilter);
        }
        
        if (confidenceFilter > 0) {
            filtered = filtered.filter(s => s.confidence >= confidenceFilter);
        }
        
        if (searchFilter) {
            filtered = filtered.filter(s => 
                s.redacted_value.toLowerCase().includes(searchFilter) ||
                s.sender.toLowerCase().includes(searchFilter) ||
                s.type.toLowerCase().includes(searchFilter) ||
                (s.conversation_name && s.conversation_name.toLowerCase().includes(searchFilter))
            );
        }
        
        renderResults(filtered);
    }
    
    function getSource(secret) {
        if (secret.extra_data && secret.extra_data.source) {
            return secret.extra_data.source;
        }
        if (secret.conversation_id === 'email') return 'email';
        if (secret.sender === 'file') return 'file';
        return 'teams';
    }
    
    function getSourceBadge(secret) {
        const source = getSource(secret);
        if (source === 'email') return '<span class="badge bg-info"><i class="bi bi-envelope me-1"></i>Email</span>';
        if (source === 'file') return '<span class="badge bg-success"><i class="bi bi-file-earmark me-1"></i>File</span>';
        return '<span class="badge bg-primary"><i class="bi bi-microsoft-teams me-1"></i>Teams</span>';
    }
    
    function renderResults(results) {
        const container = document.getElementById("resultsContainer");
        displayedResults = results;
        
        if (results.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">No Secrets Found</h4>
                    <p class="text-muted">No potential secrets were detected in the scanned conversations.</p>
                </div>
            `;
            return;
        }
        
        let html = "";
        
        results.forEach((secret, index) => {
            const confidenceClass = getConfidenceClass(secret.confidence);
            const confidencePercent = Math.round(secret.confidence * 100);
            
            html += `
                <div class="card secret-card ${confidenceClass}-confidence mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center mb-2">
                                    ${getSourceBadge(secret)}
                                    <span class="badge badge-secret-type ms-2 me-2">${escapeHtml(secret.type)}</span>
                                    <span class="badge bg-${confidenceClass === 'high' ? 'danger' : confidenceClass === 'medium' ? 'warning' : 'success'}">
                                        ${confidencePercent}% confidence
                                    </span>
                                </div>
                                
                                <div class="mb-2">
                                    <strong>Redacted Value:</strong>
                                    <code class="redacted-secret">${escapeHtml(secret.redacted_value)}</code>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-person me-1"></i>${escapeHtml(secret.sender)}
                                        <span class="mx-2">|</span>
                                        <i class="bi bi-clock me-1"></i>${formatTimestamp(secret.timestamp)}
                                        <span class="mx-2">|</span>
                                        <i class="bi bi-graph-up me-1"></i>Entropy: ${secret.entropy}
                                    </small>
                                </div>
                                
                                ${secret.conversation_name ? `
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-chat me-1"></i>Conversation: ${escapeHtml(secret.conversation_name)}
                                    </small>
                                </div>
                                ` : ''}
                                
                                <div class="mt-3">
                                    <small class="text-muted">Context:</small>
                                    <div class="bg-dark rounded p-2 mt-1" style="font-size: 0.85rem;">
                                        <span class="text-muted">${escapeHtml(secret.context_before)}</span>
                                        <span class="context-highlight">${escapeHtml(secret.redacted_value)}</span>
                                        <span class="text-muted">${escapeHtml(secret.context_after)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-primary btn-sm me-1" 
                                        data-secret-index="${index}"
                                        onclick="showSecretContext(displayedResults[this.dataset.secretIndex])">
                                    <i class="bi bi-chat-text me-1"></i>View Context
                                </button>
                                <button class="btn btn-outline-danger btn-sm" 
                                        onclick="deleteResult(${secret.id}, this)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    async function showSecretContext(secret) {
        if (!secret) {
            console.error('No secret provided');
            return;
        }
        const modal = new bootstrap.Modal(document.getElementById("contextModal"));
        const modalBody = document.getElementById("contextModalBody");
        const source = getSource(secret);
        
        // Show loading
        modalBody.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Loading context...</p>
            </div>
        `;
        modal.show();
        
        if (source === 'teams') {
            await showTeamsContextModal(secret, modalBody);
        } else if (source === 'email') {
            await showEmailContextModal(secret, modalBody);
        } else {
            showFileContextModal(secret, modalBody);
        }
    }
    
    async function showTeamsContextModal(secret, modalBody) {
        try {
            // Fetch messages from the conversation
            const response = await fetch('/api/get_teams_messages/' + encodeURIComponent(secret.conversation_id));
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            const messages = data.messages || [];
            
            // Filter out system messages and clean content
            const cleanMessages = messages.filter(msg => {
                const content = msg.content || '';
                if (content.includes('orgid:') || content.includes('8:orgid:')) return false;
                if (content.match(/^https?:\/\/.*teams\.microsoft\.com/i)) return false;
                if (content.match(/^[a-f0-9-]{30,}$/i)) return false;
                return true;
            }).map(msg => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = DOMPurify.sanitize(msg.content || '');
                return {
                    sender: msg.sender || 'Unknown',
                    content: tempDiv.textContent || tempDiv.innerText || '',
                    timestamp: msg.timestamp
                };
            }).filter(msg => msg.content.trim());
            
            let html = `
                <div class="mb-3 pb-2 border-bottom border-secondary d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-microsoft-teams text-primary me-2"></i>
                        <strong>${escapeHtml(secret.conversation_name || 'Teams Conversation')}</strong>
                    </div>
                    <span class="badge bg-danger"><i class="bi bi-exclamation-triangle me-1"></i>Contains Potential Secret</span>
                </div>
                
                <div class="mb-3 small text-muted">
                    <div><strong>Conversation ID:</strong> <code>${escapeHtml(secret.conversation_id || '')}</code></div>
                    <div><strong>Target Message ID:</strong> <code>${escapeHtml(secret.message_id || '')}</code></div>
                </div>
                
                <div class="card bg-dark border-secondary mb-3">
                    <div class="card-header">
                        <i class="bi bi-chat-dots me-2"></i>Messages (context)
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
            `;
            
            if (cleanMessages.length === 0) {
                html += '<p class="text-muted">No messages to display</p>';
            } else {
                // Get secret value - try raw_value first, then extract from redacted
                let secretValue = secret.raw_value || '';
                if (!secretValue && secret.redacted_value) {
                    // Extract non-asterisk parts from redacted value for matching
                    secretValue = secret.redacted_value.replace(/\*/g, '');
                }
                const secretLower = secretValue.toLowerCase();
                
                cleanMessages.forEach(msg => {
                    // Check if this message contains the secret
                    const msgLower = msg.content.toLowerCase();
                    const containsSecret = secretLower.length > 3 && msgLower.includes(secretLower);
                    
                    html += `
                        <div class="d-flex justify-content-end mb-3">
                            <div class="p-3 rounded-3 ${containsSecret ? 'bg-danger bg-opacity-75' : 'bg-secondary bg-opacity-50'}" style="max-width: 85%;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong class="text-light">${escapeHtml(msg.sender)}</strong>
                                    <small class="text-muted ms-3">${formatTimestamp(msg.timestamp)}</small>
                                </div>
                                <div class="text-light" style="white-space: pre-wrap;">${escapeHtml(msg.content)}</div>
                                ${containsSecret ? '<div class="mt-2"><span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i>Secret Detected Here</span></div>' : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `
                    </div>
                </div>
                
                <div class="card bg-danger bg-opacity-10 border-danger">
                    <div class="card-header small text-danger">
                        <i class="bi bi-exclamation-triangle me-1"></i>Detected Secret
                    </div>
                    <div class="card-body">
                        <span class="badge bg-warning text-dark me-2">${escapeHtml(secret.type)}</span>
                        <code class="text-danger fs-6">${escapeHtml(secret.raw_value || secret.redacted_value)}</code>
                    </div>
                </div>
            `;
            
            modalBody.innerHTML = html;
        } catch (error) {
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Failed to load Teams messages: ${escapeHtml(error.message)}
                </div>
            `;
        }
    }
    
    async function showEmailContextModal(secret, modalBody) {
        // Try to fetch full email content
        let email = null;
        let cleanBody = '';
        
        if (secret.message_id) {
            try {
                const response = await fetch('/api/get_email/' + secret.message_id);
                const data = await response.json();
                if (!data.error && data.email) {
                    email = data.email;
                    const bodyContent = email.body?.content || email.bodyPreview || '';
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = DOMPurify.sanitize(bodyContent);
                    cleanBody = tempDiv.textContent || tempDiv.innerText || '';
                    cleanBody = cleanBody.replace(/\s+/g, ' ').trim();
                }
            } catch (e) {
                console.log('Could not fetch email:', e);
            }
        }
        
        // Fallback to stored content
        if (!cleanBody) {
            let fullContent = secret.message_content || '';
            if (!fullContent) {
                fullContent = (secret.context_before || '') + (secret.raw_value || secret.redacted_value || '') + (secret.context_after || '');
            }
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = DOMPurify.sanitize(fullContent);
            cleanBody = tempDiv.textContent || tempDiv.innerText || '';
            cleanBody = cleanBody.replace(/\s+/g, ' ').trim();
        }
        
        // Highlight secret in content
        const secretValue = secret.raw_value || '';
        let highlightedBody = escapeHtml(cleanBody);
        if (secretValue.length > 3) {
            const regex = new RegExp('(' + secretValue.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            highlightedBody = highlightedBody.replace(regex, '<mark class="bg-danger text-white px-1 rounded">$1</mark>');
        }
        
        const emailSubject = email?.subject || secret.conversation_name || 'Email';
        const emailFrom = email?.from?.emailAddress?.address || secret.sender || 'Unknown';
        const emailTo = email?.toRecipients?.map(r => r.emailAddress?.address).join(', ') || 'N/A';
        const emailDate = email?.sentDateTime || secret.timestamp;
        
        let html = `
            <div class="mb-3 pb-2 border-bottom border-danger d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-envelope text-info me-2"></i>
                    <strong>${escapeHtml(emailSubject)}</strong>
                </div>
                <span class="badge bg-danger"><i class="bi bi-exclamation-triangle me-1"></i>Contains Potential Secret</span>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="small"><strong>From:</strong> ${escapeHtml(emailFrom)}</div>
                    <div class="small"><strong>To:</strong> ${escapeHtml(emailTo)}</div>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="small text-muted"><i class="bi bi-clock me-1"></i>${formatTimestamp(emailDate)}</div>
                    ${secret.message_id ? `<div class="small text-muted"><i class="bi bi-envelope me-1"></i>ID: ${secret.message_id.substring(0, 20)}...</div>` : ''}
                </div>
            </div>
            
            <div class="card bg-dark border-secondary mb-3">
                <div class="card-header d-flex justify-content-between">
                    <span><i class="bi bi-body-text me-2"></i>Email Content</span>
                    <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i>Secret highlighted in red</span>
                </div>
                <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                    <div style="white-space: pre-wrap; word-break: break-word; font-size: 0.9rem; line-height: 1.6;">${highlightedBody}</div>
                </div>
            </div>
            
            <div class="card bg-danger bg-opacity-10 border-danger mb-3">
                <div class="card-header text-danger">
                    <i class="bi bi-shield-exclamation me-2"></i>Detected Secret
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center p-2 bg-dark rounded">
                        <span class="badge bg-warning text-dark me-3">${escapeHtml(secret.type)}</span>
                        <code class="text-danger flex-grow-1" style="font-size: 1rem;">${escapeHtml(secret.raw_value || secret.redacted_value)}</code>
                        <span class="badge bg-secondary ms-2">${Math.round((secret.confidence || 0) * 100)}%</span>
                    </div>
                </div>
            </div>
        `;
        
        if (secret.message_id) {
            html += `
                <div class="d-flex gap-2">
                    <button class="btn btn-info btn-sm" onclick="downloadEml('${secret.message_id}')">
                        <i class="bi bi-download me-2"></i>Download .eml
                    </button>
                </div>
            `;
        }
        
        modalBody.innerHTML = html;
    }
    
    function showFileContextModal(secret, modalBody) {
        let fullContent = secret.message_content || '';
        if (!fullContent) {
            fullContent = (secret.context_before || '') + (secret.raw_value || secret.redacted_value || '') + (secret.context_after || '');
        }
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = DOMPurify.sanitize(fullContent);
        let cleanContent = tempDiv.textContent || tempDiv.innerText || '';
        
        let html = `
            <div class="mb-3 pb-2 border-bottom border-secondary d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-file-earmark-text text-success me-2"></i>
                    <strong>${escapeHtml(secret.conversation_name || 'File')}</strong>
                </div>
                <span class="badge bg-danger"><i class="bi bi-exclamation-triangle me-1"></i>Contains Potential Secret</span>
            </div>
            
            <div class="card bg-dark border-secondary mb-3">
                <div class="card-header">
                    <i class="bi bi-code me-2"></i>File Content
                </div>
                <div class="card-body">
                    <pre class="mb-0 text-light" style="white-space: pre-wrap; word-break: break-word; font-size: 0.85rem;">${escapeHtml(cleanContent)}</pre>
                </div>
            </div>
            
            <div class="card bg-danger bg-opacity-10 border-danger">
                <div class="card-header small text-danger">
                    <i class="bi bi-exclamation-triangle me-1"></i>Detected Secret
                </div>
                <div class="card-body">
                    <span class="badge bg-warning text-dark me-2">${escapeHtml(secret.type)}</span>
                    <code class="text-danger fs-6">${escapeHtml(secret.redacted_value)}</code>
                </div>
            </div>
        `;
        
        modalBody.innerHTML = html;
    }
    
    async function downloadEml(messageId) {
        try {
            const response = await fetch('/api/download_email/' + messageId);
            if (!response.ok) {
                const data = await response.json();
                showToast('Error', data.error || 'Failed to download', 'error');
                return;
            }
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'email_' + messageId + '.eml';
            a.click();
            URL.revokeObjectURL(url);
        } catch (error) {
            showToast('Error', 'Failed to download: ' + error.message, 'error');
        }
    }
    
    async function exportResults() {
        try {
            const response = await fetch("/api/export_results");
            const data = await response.json();
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `teams_secrets_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast("Success", "Results exported successfully", "success");
            
        } catch (error) {
            showToast("Error", "Failed to export results: " + error.message, "error");
        }
    }
    
    async function deleteResult(secretId, btn) {
        if (!confirm('Delete this result?')) return;
        
        try {
            const response = await fetch('/api/delete_secret/' + secretId, { method: 'DELETE' });
            const data = await response.json();
            
            if (data.success) {
                // Remove from local array and re-render (use == for type coercion)
                allResults = allResults.filter(s => s.id != secretId);
                filterResults();
                document.getElementById("secretsCount").textContent = allResults.length;
                showToast("Success", "Result deleted from database", "success");
            } else {
                showToast("Error", data.error || "Failed to delete", "error");
            }
        } catch (error) {
            showToast("Error", "Failed to delete: " + error.message, "error");
        }
    }
    
    async function clearAllResults() {
        if (!confirm('Delete this scan and ALL its data? This cannot be undone.')) return;
        
        try {
            let url = '/api/clear_all_secrets';
            if (currentScanId) {
                url += '?scan_id=' + currentScanId;
            }
            const response = await fetch(url, { method: 'DELETE' });
            const data = await response.json();
            
            if (data.success) {
                showToast("Success", "Scan deleted from database", "success");
                // Redirect to history after deletion
                setTimeout(() => { window.location.href = '/history'; }, 1000);
            } else {
                showToast("Error", data.error || "Failed to clear", "error");
            }
        } catch (error) {
            showToast("Error", "Failed to clear: " + error.message, "error");
        }
    }
</script>
{% endblock %}
